pipeline {
    agent any
	environment {
		GCP_SSH_KEY = credentials('rsa-jenkins-worker')							
	}

    stages {
		stage('Backup DB') {
			steps {
				echo 'Build app'
				sh 'ssh -o StrictHostKeyChecking=no -i "$GCP_SSH_KEY" rudic@10.184.0.13 "sudo mysqldump db_customers > backup-db-customers-${BUILD_NUMBER}.sql"'
			}
		}	
		stage('Upload to GCS') {
			steps {
				echo 'Uploading to GCS ...'
				sh 'ssh -o StrictHostKeyChecking=no -i "$GCP_SSH_KEY" rudic@10.184.0.13 "gsutil cp backup-db-customers-${BUILD_NUMBER}.sql gs://storage-data-mariadb-rudicatsmile"'
			}
		}								
	}
}
